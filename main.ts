namespace SpriteKind {
    export const HUD = SpriteKind.create()
    export const Tower = SpriteKind.create()
}
namespace myTiles {
    //% blockIdentity=images._tile
    export const tile0 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile1 = img`
. . . . . . . . . . . . . . . . 
. b b b b b b b b b b b b b b . 
. b b b b b b b b b b b b b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b . . . . . . . . . . b b . 
. b b b b b b b b b b b b b b . 
. b b b b b b b b b b b b b b . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile2 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . 6 6 6 6 6 6 . . . . . 
. . . . 6 6 6 6 6 6 6 6 . . . . 
. . . 6 6 6 6 6 6 6 6 6 6 . . . 
. . . 6 6 6 6 6 6 6 6 6 6 . . . 
. . . 6 6 6 6 6 6 6 6 6 6 . . . 
. . . 6 6 6 6 6 6 6 6 6 6 . . . 
. . . 6 6 6 6 6 6 6 6 6 6 . . . 
. . . 6 6 6 6 6 6 6 6 6 6 . . . 
. . . . 6 6 6 6 6 6 6 6 . . . . 
. . . . . 6 6 6 6 6 6 . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile3 = img`
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
f f f f f f f f f f f f f f f f 
`
    //% blockIdentity=images._tile
    export const tile4 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . 2 2 2 2 2 2 2 2 2 2 . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile5 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . b . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile6 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile7 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . b b b b . . . . . . 
. . . . . . b b b b . . . . . . 
. . . . . . b b b b . . . . . . 
. . . . . . b b b b . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile8 = img`
. . . . . . . . . . . . . . . . 
. . . . . 6 6 6 6 6 6 . . . . . 
. . . . 6 6 6 6 6 6 6 6 . . . . 
. . . 6 6 7 7 7 7 7 7 6 6 . . . 
. . 6 6 7 7 7 7 7 7 7 7 6 6 . . 
. 6 6 7 7 7 7 7 7 7 7 7 7 6 6 . 
. 6 6 7 7 7 7 7 7 7 7 7 7 6 6 . 
. 6 6 7 7 7 7 7 7 7 7 7 7 6 6 . 
. 6 6 7 7 7 7 7 7 7 7 7 7 6 6 . 
. 6 6 7 7 7 7 7 7 7 7 7 7 6 6 . 
. 6 6 7 7 7 7 7 7 7 7 7 7 6 6 . 
. . 6 6 7 7 7 7 7 7 7 7 6 6 . . 
. . . 6 6 7 7 7 7 7 7 6 6 . . . 
. . . . 6 6 6 6 6 6 6 6 . . . . 
. . . . . 6 6 6 6 6 6 . . . . . 
. . . . . . . . . . . . . . . . 
`
    //% blockIdentity=images._tile
    export const tile9 = img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . 6 6 6 6 6 6 6 6 6 6 6 6 . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`
}
function spawn_mob () {
    mob = sprites.create(img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . 4 4 . . . . . . . 
. . . . . . 4 4 4 4 . . . . . . 
. . . . . 4 4 4 4 4 4 . . . . . 
. . . . . 4 4 4 4 4 4 . . . . . 
. . . . . . 4 4 4 4 . . . . . . 
. . . . . . . 4 4 . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`, SpriteKind.Enemy)
    healthbar = statusbars.create(6, 1, StatusBarKind.Health)
    healthbar.attachToSprite(mob)
    healthbar.max = 3
    enemiesLeft += -1
    tiles.placeOnRandomTile(mob, myTiles.tile4)
    if (path) {
        scene.followPath(mob, path, enemySpeed)
    }
}
controller.B.onEvent(ControllerButtonEvent.Pressed, function () {
    minimapVisible = !(minimapVisible)
    minimapSprite.setFlag(SpriteFlag.Invisible, !(minimapVisible))
})
sprites.onOverlap(SpriteKind.Enemy, SpriteKind.Projectile, function (sprite, otherSprite) {
    healthbar = statusbars.getStatusBarAttachedTo(StatusBarKind.Health, sprite)
    healthbar.value += -1
    if (healthbar.value == 0) {
        sprite.destroy()
        info.changeScoreBy(1)
    }
    otherSprite.destroy()
})
controller.A.onEvent(ControllerButtonEvent.Pressed, function () {
    build_tower()
})
info.onCountdownEnd(function () {
    isSpawning = true
    enemiesLeft = nextWaveSize
    nextWaveSize += 20
    nextWaveTime += 5
})
scene.onOverlapTile(SpriteKind.Enemy, myTiles.tile2, function (sprite, location) {
    sprite.destroy()
    info.changeLifeBy(-1)
})
function build_tower () {
    if (5 <= info.score()) {
        buildLoc = tilemap.locationOfSprite(cursor)
        if (tilemap.tileIs(buildLoc, myTiles.tile5) || tilemap.tileIs(buildLoc, myTiles.tile7)) {
            tiles.setWallAt(buildLoc, true)
            try_update_path()
            if (newPath) {
                tiles.setTileAt(buildLoc, myTiles.tile9)
                tower = sprites.create(img`
8 8 8 8 8 8 
8 8 8 8 8 8 
8 8 8 8 8 8 
8 8 8 8 8 8 
8 8 8 8 8 8 
8 8 8 8 8 8 
`, SpriteKind.Tower)
                tiles.placeOnTile(tower, buildLoc)
                info.changeScoreBy(-5)
            }
        }
    }
}
function try_update_path () {
    newPath = scene.aStar(spawnLoc, homeLoc)
    if (newPath) {
        path = newPath
        for (let value of tiles.getTilesByType(myTiles.tile7)) {
            tiles.setTileAt(value, myTiles.tile5)
        }
        for (let value2 of path) {
            if (tilemap.tileIs(value2, myTiles.tile5)) {
                tiles.setTileAt(value2, myTiles.tile7)
            }
        }
        for (let value of sprites.allOfKind(SpriteKind.Enemy)) {
            scene.followPath(value, path, enemySpeed)
        }
    } else {
        tiles.setWallAt(buildLoc, false)
        cursor.say("I cannot build here", 1000)
    }
}
let projectile: Sprite = null
let minimap2: minimap.Minimap = null
let tower: Sprite = null
let newPath: tiles.Location[] = []
let buildLoc: tiles.Location = null
let path: tiles.Location[] = []
let enemiesLeft = 0
let healthbar: StatusBarSprite = null
let mob: Sprite = null
let nextWaveSize = 0
let isSpawning = false
let enemySpeed = 0
let minimapSprite: Sprite = null
let minimapVisible = false
let spawnLoc: tiles.Location = null
let homeLoc: tiles.Location = null
let cursor: Sprite = null
tiles.setTilemap(tiles.createTilemap(
            hex`10000e000505050505050505050505050505050505020505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505040505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505050505`,
            img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`,
            [myTiles.tile0,myTiles.tile1,myTiles.tile2,myTiles.tile3,myTiles.tile4,myTiles.tile5,myTiles.tile6,myTiles.tile7,myTiles.tile8,myTiles.tile9],
            TileScale.Sixteen
        ))
scene.setBackgroundColor(13)
cursor = sprites.create(img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . f f . . . . . . . 
. . . . . . . f f . . . . . . . 
. . . . . f f f f f f . . . . . 
. . . . . f f f f f f . . . . . 
. . . . . . . f f . . . . . . . 
. . . . . . . f f . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`, SpriteKind.Player)
controller.moveSprite(cursor, 100, 100)
cursor.setFlag(SpriteFlag.StayInScreen, true)
cursor.setFlag(SpriteFlag.Ghost, true)
homeLoc = tiles.getTilesByType(myTiles.tile2)[0]
spawnLoc = tiles.getTilesByType(myTiles.tile4)[0]
minimapVisible = false
minimapSprite = sprites.create(img`
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
. . . . . . . . . . . . . . . . 
`, SpriteKind.HUD)
minimapSprite.setFlag(SpriteFlag.RelativeToCamera, true)
minimapSprite.z = 10
try_update_path()
enemySpeed = 10
isSpawning = false
nextWaveSize = 20
let nextWaveTime = 2
info.startCountdown(nextWaveTime)
info.setScore(20)
info.setLife(3)
game.onUpdateInterval(100, function () {
    if (minimapVisible) {
        minimap2 = minimap.minimap(MinimapScale.Quarter, 100, 13)
        minimapSprite.setImage(minimap.getImage(minimap2))
        minimapSprite.x = scene.screenWidth() / 2
        minimapSprite.y = scene.screenHeight() / 2
        for (let value of sprites.allOfKind(SpriteKind.Enemy)) {
            minimap.includeSprite(minimap2, value, MinimapSpriteScale.Double)
        }
        minimap.includeSprite(minimap2, cursor, MinimapSpriteScale.Double)
    }
})
game.onUpdateInterval(500, function () {
    if (isSpawning && 0 < enemiesLeft) {
        spawn_mob()
    } else if (isSpawning) {
        isSpawning = false
        info.startCountdown(nextWaveTime)
    }
})
game.onUpdateInterval(1000, function () {
    if (sprites.allOfKind(SpriteKind.Enemy).length > 0) {
        for (let value of sprites.allOfKind(SpriteKind.Tower)) {
            projectile = sprites.createProjectileFromSprite(img`
a a 
a a 
`, value, 0, 20)
            projectile.lifespan = 1000
            projectile = sprites.createProjectileFromSprite(img`
a a 
a a 
`, value, 20, 0)
            projectile.lifespan = 1000
            projectile = sprites.createProjectileFromSprite(img`
a a 
a a 
`, value, 0, -20)
            projectile.lifespan = 1000
            projectile = sprites.createProjectileFromSprite(img`
a a 
a a 
`, value, -20, 0)
            projectile.lifespan = 1000
        }
    }
})
